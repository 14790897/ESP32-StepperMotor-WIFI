# 故障排除指南

## 🔧 连接重置错误 (ERR_CONNECTION_RESET)

### 问题描述
在使用定时旋转或循环功能时，浏览器显示：
```
Failed to load resource: net::ERR_CONNECTION_RESET
启动定时旋转失败: TypeError: Failed to fetch
```

### 原因分析
这个问题通常由以下原因引起：
1. **阻塞操作**：ESP32在执行长时间任务时阻塞了Web服务器
2. **网络超时**：请求处理时间过长导致连接超时
3. **内存不足**：长时间运行导致内存泄漏
4. **WiFi信号不稳定**：网络连接质量差

### 解决方案

#### 1. 代码优化（已修复）
- ✅ 将阻塞式步进控制改为非阻塞式
- ✅ 使用状态机代替长循环
- ✅ 减少delay时间提高响应性
- ✅ 立即返回HTTP响应

#### 2. 网络优化
```bash
# 检查WiFi信号强度
ping [ESP32_IP]

# 测试基本连接
curl http://[ESP32_IP]/status
```

#### 3. 浏览器设置
- 清除浏览器缓存
- 禁用浏览器扩展
- 尝试无痕模式
- 使用不同浏览器测试

## 🌐 WiFi连接问题

### 无法连接WiFi
1. **检查配置**：
   ```cpp
   // 确认secrets.h中的配置正确
   #define WIFI_SSID "你的WiFi名称"
   #define WIFI_PASSWORD "你的WiFi密码"
   ```

2. **检查网络**：
   - 确认WiFi网络可用
   - 检查是否为2.4GHz网络（ESP32不支持5GHz）
   - 确认密码正确

3. **串口调试**：
   ```
   正在连接WiFi...
   ................
   WiFi连接成功!
   IP地址: 192.168.1.100
   ```

### WiFi连接不稳定
1. **信号强度**：移近路由器
2. **电源供应**：确保5V电源稳定
3. **天线位置**：调整ESP32位置

## 🔄 电机控制问题

### 电机不转动
1. **硬件检查**：
   - 确认接线正确
   - 检查ULN2003驱动板LED
   - 测量5V电源电压
   - 检查步进电机连接

2. **软件检查**：
   ```cpp
   // 检查引脚定义
   #define IN1 1
   #define IN2 12
   #define IN3 18
   #define IN4 19
   ```

3. **串口调试**：
   ```
   ESP32 ULN2003 步进电机WiFi控制器启动
   引脚初始化完成
   WiFi连接成功!
   ```

### 电机转动异常
1. **速度问题**：
   - 检查速度设置（1-100%）
   - 尝试不同速度值
   - 观察stepDelay变化

2. **方向问题**：
   - 检查接线顺序
   - 交换任意两根线改变方向

## 📱 Web界面问题

### 界面无法加载
1. **网络检查**：
   ```bash
   # 测试连接
   telnet [ESP32_IP] 80
   
   # 测试HTTP
   curl -v http://[ESP32_IP]/
   ```

2. **浏览器兼容性**：
   - 使用现代浏览器（Chrome、Firefox、Safari、Edge）
   - 启用JavaScript
   - 检查网络设置

### 按钮无响应
1. **JavaScript错误**：
   - 打开浏览器开发者工具
   - 查看Console错误信息
   - 检查Network请求状态

2. **网络延迟**：
   - 检查网络延迟
   - 等待响应完成
   - 避免快速连续点击

## 🔍 调试方法

### 串口监视器
```bash
# 启动监视器
pio device monitor --port COM20 --baud 115200

# 观察输出
ESP32 ULN2003 步进电机WiFi控制器启动
引脚初始化完成
正在连接WiFi...
WiFi连接成功!
IP地址: 192.168.1.100
Web服务器已启动
```

### 浏览器开发者工具
1. **Console标签**：查看JavaScript错误
2. **Network标签**：查看HTTP请求状态
3. **Application标签**：检查本地存储

### 网络工具
```bash
# 检查连接
ping 192.168.1.100

# 测试端口
telnet 192.168.1.100 80

# HTTP测试
curl -X GET "http://192.168.1.100/status"
```

## ⚡ 性能优化

### 提高响应速度
1. **减少延迟**：
   ```cpp
   delay(1); // 而不是delay(10)
   ```

2. **优化循环**：
   - 避免长时间阻塞
   - 使用非阻塞算法
   - 及时处理停止请求

### 内存管理
1. **监控内存使用**：
   ```cpp
   Serial.println("Free heap: " + String(ESP.getFreeHeap()));
   ```

2. **避免内存泄漏**：
   - 及时释放资源
   - 避免动态分配
   - 重置全局变量

## 🛠️ 常用修复命令

### 重置系统
```bash
# 重新编译上传
pio run --target clean
pio run --target upload

# 重启ESP32
# 按下RST按钮或断电重启
```

### 恢复出厂设置
```cpp
// 在setup()中添加
WiFi.disconnect(true);
delay(1000);
```

### 网络重连
```cpp
// 检查WiFi状态
if (WiFi.status() != WL_CONNECTED) {
  WiFi.reconnect();
}
```

## 📞 获取帮助

### 日志收集
1. 串口输出完整日志
2. 浏览器Console错误信息
3. Network请求详细信息
4. 硬件连接照片

### 问题报告格式
```
问题描述：[详细描述问题现象]
硬件配置：[ESP32型号、驱动板型号等]
软件版本：[代码版本、库版本等]
网络环境：[路由器型号、WiFi设置等]
错误信息：[完整的错误日志]
复现步骤：[详细的操作步骤]
```

### 测试清单
- [ ] 硬件连接正确
- [ ] WiFi配置正确
- [ ] 串口输出正常
- [ ] 基本控制功能正常
- [ ] 网络连接稳定
- [ ] 浏览器兼容性确认
